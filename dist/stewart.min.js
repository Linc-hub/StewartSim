/*
Stewart v1.1.2 10/6/2024
https://raw.org/research/inverse-kinematics-of-a-stewart-platform/

Copyright (c) 2024, Robert Eisele (https://raw.org/)
Licensed under the MIT license.
*/
'use strict';(function(D){function G(a,d,b){var c=[];a=(2*a-d)/Math.sqrt(3);for(var n=0;6>n;n++){var h=(n-n%2)/3*Math.PI+b,e=a*Math.pow(-1,n);c.push({x:d*Math.cos(h)+e*Math.sin(h),y:d*Math.sin(h)-e*Math.cos(h)})}return c}function H(a){a=a.match(/[a-z]|[-+]?([0-9]*\.[0-9]+|[0-9]+)/ig);for(var d=[],b=0,c=0,n=null,h=null,e,g=!1;0<a.length;){if(-1!=="MmZzLlHhVvCcSsQqTtAa".indexOf(a[0]))e=h,h=a.shift(),g=-1==="MZLHVCSQTA".indexOf(h),h=h.toUpperCase();else{if(null===h)throw Error("Invalid implicit command");
e=h}switch(h){case "M":e=+a.shift();var f=+a.shift();g?(b+=e,c+=f):(b=e,c=f);d.push({cmd:"move",x:b,y:c});n={x:b,y:c};h="L";break;case "L":e=+a.shift();f=+a.shift();g&&(e+=b,f+=c);d.push({cmd:"line",x1:b,y1:c,x2:e,y2:f});b=e;c=f;break;case "H":e=+a.shift();g&&(e+=b);d.push({cmd:"line",x1:b,y1:c,x2:e,y2:c});b=e;break;case "V":f=+a.shift();g&&(f+=c);d.push({cmd:"line",x1:b,y1:c,x2:b,y2:f});c=f;break;case "Z":n&&(d.push({cmd:"line",x1:b,y1:c,x2:n.x,y2:n.y}),b=n.x,c=n.y);h=n=null;break;case "C":var p=
+a.shift(),m=+a.shift(),k=+a.shift(),l=+a.shift();e=+a.shift();f=+a.shift();g&&(p+=b,m+=c,k+=b,l+=c,e+=b,f+=c);d.push({cmd:"cubic",x0:b,y0:c,x1:p,y1:m,x2:k,y2:l,x3:e,y3:f,bezier:new Bezier(b,c,p,m,k,l,e,f)});b=e;c=f;break;case "S":"C"!==e&&"S"!==e?(p=b,m=c):(p=b+b-d[d.length-1].x2,m=c+c-d[d.length-1].y2);k=+a.shift();l=+a.shift();e=+a.shift();f=+a.shift();g&&(k+=b,l+=c,e+=b,f+=c);d.push({cmd:"cubic",x0:b,y0:c,x1:p,y1:m,x2:k,y2:l,x3:e,y3:f,bezier:new Bezier(b,c,p,m,k,l,e,f)});b=e;c=f;break;case "Q":p=
+a.shift();m=+a.shift();e=+a.shift();f=+a.shift();g&&(p+=b,m+=c,e+=b,f+=c);d.push({cmd:"quadratic",x0:b,y0:c,x1:p,y1:m,x2:e,y2:f,bezier:new Bezier(b,c,p,m,e,f)});b=e;c=f;break;case "T":"Q"!==e&&"T"!==e?(p=b,m=c):(p=b+b-d[d.length-1].x1,m=c+c-d[d.length-1].y1);e=+a.shift();f=+a.shift();g&&(e+=b,f+=c);d.push({cmd:"quadratic",x0:b,y0:c,x1:p,y1:m,x2:e,y2:f,bezier:new Bezier(b,c,p,m,e,f)});b=e;c=f;break;case "A":p=+a.shift();m=+a.shift();k=+a.shift();l=+a.shift();var r=+a.shift();e=+a.shift();f=+a.shift();
g&&(e+=b,f+=c);d.push({cmd:"arc",rx:p,ry:m,axisRotation:k,largeArcFlag:l,sweepFlag:r,x:e,y:f});b=e;c=f;break;default:throw Error("Invalid SVG command "+h);}}return d}function B(a){this.platform=a;this.orientation=Quaternion.ONE;this.translation=[0,0,0];this.start("wobble")}function F(){}B.SVG=function(a,d){function b(y,A,w){var z=(y-d.x)/d.width*80-40,C=(A-d.y)/d.height*80-40;n.push({orig:e.cmd,x:z,y:C,z:w,t:Math.hypot(z-((c.x-d.x)/d.width*80-40),C-((c.y-d.y)/d.height*80-40),w-c.z)/.05});c.x=y;c.y=
A;c.z=w}var c={x:d.width/2,y:d.height/2,z:0},n=[];a=H(a);for(var h=0;h<a.length;h++){var e=a[h];switch(e.cmd){case "move":b(c.x,c.y,-10);b(e.x,e.y,-10);b(e.x,e.y,0);break;case "line":b(e.x2,e.y2,0);break;case "quadratic":case "cubic":for(var g=e.bezier.getLUT(),f=0;f<g.length;f++)b(g[f].x,g[f].y,0);break;case "arc":var p=c.x,m=c.y,k=e.x,l=e.y;g=e.axisRotation;f=e.sweepFlag;var r=e.rx,v=e.ry,q=Math.cos(g)*(p-k)/2+Math.sin(g)*(m-l)/2,t=-Math.sin(g)*(p-k)/2+Math.cos(g)*(m-l)/2,u=(e.largeArcFlag===f?
-1:1)*Math.sqrt((r*r*v*v-r*r*t*t-v*v*q*q)/(r*r*t*t+v*v*q*q)),x=u*r*t/v;u=u*-v*q/r;p=(p+k)/2+Math.cos(g)*x-Math.sin(g)*u;m=(m+l)/2+Math.sin(g)*x+Math.cos(g)*u;k=function(y,A,w,z){return(y*z<A*w?-1:1)*Math.acos((y*w+A*z)/Math.sqrt((y*y+A*A)*(w*w+z*z)))};l=k(1,0,(q-x)/r,(t-u)/v);q=k((q-x)/r,(t-u)/v,(-q-x)/r,(-t-u)/v);0===f&&0<q?q-=2*Math.PI:1===f&&0>q&&(q+=2*Math.PI);t=Math.ceil(Math.abs(q*Math.max(r,v))/2);for(f=0;f<=t;f++)u=l+f/t*q,x=r*Math.cos(u),u=v*Math.sin(u),b(p+(x*Math.cos(g)-u*Math.sin(g)),
m+(x*Math.sin(g)+u*Math.cos(g)),0)}}return B.Interpolate(n)};B.Interpolate=function(a){for(var d=0,b=1;b<a.length;b++)d+=a[b].t;return{duration:d,pathVisible:!0,next:null,fn:function(c){this.orientation=Quaternion.ONE;for(var n=0,h=1;h<a.length;h++){var e=a[h],g=n+e.t/d;if(n<=c&&c<g){c=(c-n)/(g-n);h=0===h?a[0]:a[h-1];this.translation[0]=h.x+(e.x-h.x)*c;this.translation[1]=h.y+(e.y-h.y)*c;this.translation[2]=h.z+(e.z-h.z)*c;return}n=g}this.translation[0]=a[a.length-1].x;this.translation[1]=a[a.length-
1].y;this.translation[2]=a[a.length-1].z}}};B.prototype={cur:null,next:null,startTime:0,platform:null,translation:null,orientation:null,pathVisible:!0,toggleVisiblePath:function(){this.pathVisible=!this.pathVisible},drawPath:function(a){if(this.pathVisible&&this.cur.pathVisible){a.beginShape();a.noFill();a.stroke(255,0,0);for(var d=0;100>=d;d++)this.cur.fn.call(this,d/100,a),a.vertex(this.translation[0],this.translation[1],this.translation[2]+this.platform.T0[2]);a.endShape()}},start:function(a){this.map[a]&&
(a=this.map[a]);this.fn[a]?this._start(this.fn[a],this.fn[a].next):console.log("Failed ",a)},_start:function(a,d){a.start&&a.start.call(this);this.cur=a;this.next=d;this.startTime=Date.now()},moveTo:function(a,d,b,c){var n=this.translation.slice(),h=this.orientation.clone().slerp(d);this.cur={duration:b,pathVisible:!1,fn:function(e){this.orientation=h(e);this.translation=[n[0]+e*(a[0]-n[0]),n[1]+e*(a[1]-n[1]),n[2]+e*(a[2]-n[2])]}};this.startTime=Date.now();this.next=c},update:function(a){var d=(Date.now()-
this.startTime)/this.cur.duration;1<d&&(d=1);this.cur.fn.call(this,d,a);1===d&&0!==this.cur.duration&&null!==this.next&&this.start(this.next);this.platform.update(this.translation,this.orientation)},fn:{rotate:{duration:4E3,pathVisible:!1,next:"rotate",fn:function(a){a=Math.pow(Math.sin(a*Math.PI*2-8*Math.PI),5)/2;this.translation[0]=0;this.translation[1]=0;this.translation[2]=0;this.orientation=Quaternion.fromAxisAngle([0,0,1],a)}},tilt:{duration:7E3,pathVisible:!1,next:"tilt",fn:function(a){var d=
0,b=0;.25>a?(a*=4,d=0):.5>a?(a=4*(a-.25),d=1*Math.PI/3):.75>a?(a=4*(a-.5),d=2*Math.PI/3):(a=4*(a-.75),b=1);var c=0,n=0;0===b&&(c=Math.sin(d),n=-Math.cos(d));a=Math.pow(Math.sin(a*Math.PI*2-8*Math.PI),5)/3;this.translation[0]=0;this.translation[1]=0;this.translation[2]=0;this.orientation=Quaternion.fromAxisAngle([c,n,b],a)}},square:function(){var a=B.Interpolate([{x:-30,y:-30,z:10,t:0},{x:-30,y:30,z:0,t:1E3},{x:30,y:30,z:10,t:1E3},{x:30,y:-30,z:0,t:1E3},{x:-30,y:-30,z:10,t:1E3}]);a.next="square";return a}(),
wobble:{duration:3E3,pathVisible:!1,next:"wobble",fn:function(a){a=2*a*Math.PI;this.translation[0]=13*Math.cos(-a);this.translation[1]=13*Math.sin(-a);this.translation[2]=0;this.orientation=(new Quaternion(-13,-Math.cos(a),Math.sin(a),0)).normalize()}},breathe:{duration:5E3,pathVisible:!1,next:"breathe",fn:function(a){this.translation=[0,0,Math.exp(Math.sin(2*Math.PI*a)-1)/(Math.E*Math.E-1)*50];this.orientation=Quaternion.ONE}},eight:{duration:3500,pathVisible:!0,next:"eight",fn:function(a){a=(-.5+
2*a)*Math.PI;this.translation=[30*Math.cos(a),Math.sin(a)*Math.cos(a)*30,0];this.orientation=Quaternion.ONE}},lissajous:{duration:1E4,pathVisible:!0,next:"lissajous",fn:function(a){this.translation=[30*Math.sin(6*a*Math.PI),30*Math.sin(4*a*Math.PI),0];this.orientation=Quaternion.ONE}},helical:{duration:5E3,pathVisible:!0,next:null,fn:function(a){a=1-a;this.translation=[20*Math.cos(a*Math.PI*8),20*Math.sin(a*Math.PI*8),20*a];this.orientation=Quaternion.ONE}},mouse:{duration:0,pathVisible:!1,next:null,
fn:function(a,d){this.translation=[(d.mouseX-512)/10,(d.mouseY-382)/10,0];this.orientation=Quaternion.ONE}},gamepad:function(){var a=!1;D.addEventListener&&(D.addEventListener("gamepadconnected",function(d){a=!0}),D.addEventListener("gamepaddisconnected",function(d){a=!1}));return{duration:0,pathVisible:!1,next:null,start:function(){this.orientation=Quaternion.ONE;this.translation=[0,0,0];a?alert("Use the joysticks and L1 button"):alert("Plug in a Playstation or Xbox controller and use the joysticks")},
fn:function(){if(a){var d=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[],b=d[0].axes;d[0].buttons[6].value?(this.orientation=Quaternion.fromAxisAngle([0,0,1],-b[3]*Math.PI/6),this.translation=[0,0,0]):(d=Math.atan2(-b[3],-b[2]),this.translation=[30*b[1],30*b[0],0],this.orientation=(new Quaternion(-13,-Math.cos(d),Math.sin(d),0)).normalize())}}}}()},map:{q:"square",w:"wobble",e:"eight",r:"rotate",t:"tilt",y:"lissajous",m:"mouse",g:"gamepad",
b:"breathe",h:"helical",p:"perlin"}};F.prototype={translation:null,orientation:null,drawBasePlate:null,drawPlatformPlate:null,rodLength:0,hornLength:0,hornDirection:0,servoRange:null,servoRangeVisible:!1,sinBeta:[],cosBeta:[],B:[],P:[],q:[],l:[],H:[],T0:[],init:function(a){this.rodLength=a.rodLength;this.hornLength=a.hornLength;this.hornDirection=a.hornDirection;this.drawBasePlate=a.drawBasePlate;this.drawPlatformPlate=a.drawPlatformPlate;this.servoRange=a.servoRange;this.servoRangeVisible=a.servoRangeVisible;
this.B=[];this.P=[];this.q=[];this.l=[];this.H=[];this.sinBeta=[];this.cosBeta=[];for(var d=a.getLegs.call(this),b=0;b<d.length;b++)this.B.push(d[b].baseJoint),this.P.push(d[b].platformJoint),this.sinBeta.push(Math.sin(d[b].motorRotation)),this.cosBeta.push(Math.cos(d[b].motorRotation)),this.q.push([0,0,0]),this.l.push([0,0,0]),this.H.push([0,0,0]);this.T0=a.absoluteHeight?[0,0,0]:[0,0,Math.sqrt(this.rodLength*this.rodLength+this.hornLength*this.hornLength-Math.pow(this.P[0][0]-this.B[0][0],2)-Math.pow(this.P[0][1]-
this.B[0][1],2))]},initCircular:function(a){a||={};var d=a.baseRadius||80,b=a.platformRadius||50,c=(a.shaftDistance||20)/d,n=(a.anchorDistance||20)/d,h=a.hornDirection||0;this.init({rodLength:a.rodLength||130,hornLength:a.hornLength||50,hornDirection:h,servoRange:a.servoRange||[-Math.PI/2,Math.PI/2],servoRangeVisible:void 0===a.servoRangeVisible?!1:a.servoRangeVisible,getLegs:function(){for(var e=[],g=0;6>g;g++){var f=Math.pow(-1,g),p=(g+g%2)*Math.PI/3+f*c/2;f=(1+g-g%2)*Math.PI/3-f*n/2;e.push({baseJoint:[Math.cos(p)*
d,Math.sin(p)*d,0],platformJoint:[Math.cos(f)*b,Math.sin(f)*b,0],motorRotation:p+(g+h)%2*Math.PI+Math.PI/2})}return e},drawBasePlate:function(e){e.stroke(0);e.fill(254,241,53);e.ellipse(0,0,2*d,2*d)},drawPlatformPlate:function(e){e.stroke(0);e.fill(42,236,253);e.ellipse(0,0,2*b,2*b)}})},initHexagonal:function(a){a||={};var d=a.platformRadius||50,b=a.platformRadiusOuter||80,c=void 0===a.platformTurn?!0:a.platformTurn,n=a.rodLength||130,h=a.hornLength||50,e=a.hornDirection||0,g=a.shaftDistance||20,
f=a.anchorDistance||20,p=G(a.baseRadius||80,a.baseRadiusOuter||110,0),m=G(d,b,c?Math.PI:0);this.init({rodLength:n,hornLength:h,hornDirection:e,servoRange:a.servoRange||[-Math.PI/2,Math.PI/2],servoRangeVisible:void 0===a.servoRangeVisible?!1:a.servoRangeVisible,getLegs:function(){for(var k=[],l=[],r=[],v=[],q=0;6>q;q++){var t=q|1,u=p[t].x,x=p[t].y,y=p[(t+1)%6].x,A=p[(t+1)%6].y,w=y-u,z=A-x,C=Math.hypot(w,z),E=Math.pow(-1,q);u=(u+y)/2;x=(x+A)/2;A=(m[t].x+m[(t+1)%6].x)/2;t=(m[t].y+m[(t+1)%6].y)/2;w/=
C;z/=C;l.push([u+w*g*E,x+z*g*E,0]);r.push([A+w*f*E,t+z*f*E,0]);v.push(Math.atan2(z,w)+(q+e)%2*Math.PI)}w=[0,1,2,3,4,5];c&&(w=[4,3,0,5,2,1]);for(q=0;q<l.length;q++)k.push({baseJoint:l[q],platformJoint:r[w[q]],motorRotation:v[q]});return k},drawBasePlate:function(k){k.stroke(0);k.fill(254,241,53);k.beginShape();for(var l=0;l<p.length;l++)k.vertex(p[l].x,p[l].y);k.endShape(k.CLOSE)},drawPlatformPlate:function(k){k.stroke(0);k.fill(42,236,253);k.beginShape();for(var l=0;l<m.length;l++)k.vertex(m[l].x,
m[l].y);k.endShape(k.CLOSE)}})},draw:function(){function a(b,c,n){var h=0,e=2*Math.PI/12;b.beginShape(b.TRIANGLE_STRIP);for(var g=0;12>=g;g++)b.vertex(0,0,0),b.vertex(c*Math.cos(h),n,c*Math.sin(h)),h+=e;b.endShape();h=0;b.beginShape(b.TRIANGLE_FAN);b.vertex(0,n,0);for(g=0;13>g;g++)b.vertex(c*Math.cos(h),n,c*Math.sin(h)),h+=e;b.endShape()}function d(b){b.push();b.strokeWeight(2);b.stroke(255,0,0);b.line(0,0,0,40,0,0);b.stroke(0,255,0);b.line(0,0,0,0,40,0);b.stroke(0,0,255);b.line(0,0,0,0,0,40);b.pop();
b.push();b.noStroke();b.fill(255,0,0);b.rotateZ(Math.PI/2);b.translate(0,-50,0);a(b,3,10);b.pop();b.push();b.noStroke();b.fill(0,255,0);b.rotateX(-Math.PI);b.translate(0,-50,0);a(b,3,10);b.pop();b.push();b.noStroke();b.fill(0,0,255);b.rotateX(-Math.PI/2);b.translate(0,-50,0);a(b,3,10);b.pop()}return function(b){d(b);b.push();this.drawBasePlate.call(this,b);b.translate(this.translation[0],this.translation[1],this.translation[2]+this.T0[2]);b.applyMatrix.apply(b,this.orientation.conjugate().toMatrix4());
this.drawPlatformPlate.call(this,b);d(b);b.pop();for(var c=0;c<this.B.length;c++)b.push(),b.translate(this.B[c][0],this.B[c][1],this.B[c][2]),b.noStroke(),b.fill(0),b.sphere(3),b.pop(),b.push(),b.translate(this.q[c][0],this.q[c][1],this.q[c][2]),b.noStroke(),b.fill(255,0,0),b.sphere(3),b.pop(),b.push(),b.stroke(255,0,0),b.strokeWeight(1),b.line(this.H[c][0],this.H[c][1],this.H[c][2],this.q[c][0],this.q[c][1],this.q[c][2]),b.stroke(0),b.line(this.B[c][0],this.B[c][1],this.B[c][2],this.H[c][0],this.H[c][1],
this.H[c][2]),b.pop(),this.servoRangeVisible&&(b.push(),b.translate(this.B[c][0],this.B[c][1],this.B[c][2]),b.rotateX(Math.PI/2),b.rotateY(Math.atan2(this.H[c][1]-this.B[c][1],this.H[c][0]-this.B[c][0])),b.fill("rgba(255,0,0,0.1)"),b.noStroke(),b.arc(0,0,2*this.hornLength,2*this.hornLength,this.servoRange[0],this.servoRange[1],b.PIE),b.pop())}}(),update:function(a,d){var b=this.hornLength,c=this.rodLength,n=this.q,h=this.l,e=this.B,g=this.P,f=this.H,p=this.T0[2];this.translation=a;this.orientation=
d;for(var m=0;m<e.length;m++){var k=d.rotateVector(g[m]),l=h[m],r=n[m],v=f[m],q=e[m];r[0]=a[0]+k[0];r[1]=a[1]+k[1];r[2]=a[2]+k[2]+p;l[0]=r[0]-q[0];l[1]=r[1]-q[1];l[2]=r[2]-q[2];k=l[0]*l[0]+l[1]*l[1]+l[2]*l[2]-c*c+b*b;r=2*b*l[2];var t=2*b*(this.cosBeta[m]*l[0]+this.sinBeta[m]*l[1]),u=r*r+t*t,x=Math.sqrt(1-k*k/u),y=Math.sqrt(u);l=k*r/u-t*x/y;k=k*t/u+r*x/y;v[0]=q[0]+b*k*this.cosBeta[m];v[1]=q[1]+b*k*this.sinBeta[m];v[2]=q[2]+b*l}},getServoAngles:function(){for(var a=[],d=0;d<this.B.length;d++)a[d]=Math.asin((this.H[d][2]-
this.B[d][2])/this.hornLength),isNaN(a[d])?a[d]=null:this.servoRange[0]<=a[d]&&a[d]<=this.servoRange[1]||(a[d]=null);return a}};F.Animation=B;D.Stewart=F})(this);
