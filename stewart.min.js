/*
Stewart.js v1.0.0 17/02/2019
http://www.xarg.org/paper/inverse-kinematics-of-a-stewart-platform/

Copyright (c) 2019, Robert Eisele (robert@xarg.org)
Dual licensed under the MIT or GPL Version 2 licenses.
*/
(function(A){function D(a,c,b){var d=[];a=(2*a-c)/Math.sqrt(3);for(var h=0;6>h;h++){var k=(h-h%2)/3*Math.PI+b,e=a*Math.pow(-1,h);d.push({x:c*Math.cos(k)+e*Math.sin(k),y:c*Math.sin(k)-e*Math.cos(k)})}return d}function E(a){a=a.match(/[a-z]|[-+]?([0-9]*\.[0-9]+|[0-9]+)/ig);for(var c=[],b=0,d=0,h=null,k=null,e,g=!1;0<a.length;){if(-1!=="MmZzLlHhVvCcSsQqTtAa".indexOf(a[0]))e=k,k=a.shift(),g=-1==="MZLHVCSQTA".indexOf(k),k=k.toUpperCase();else{if(null===k)throw Error("Invalid implicit command");e=k}switch(k){case "M":e=
+a.shift();var f=+a.shift();g?(b+=e,d+=f):(b=e,d=f);c.push({cmd:"move",x:e,y:f});h={x:b,y:d};k="L";break;case "L":e=+a.shift();f=+a.shift();g&&(e+=b,f+=d);c.push({cmd:"line",x1:b,y1:d,x2:e,y2:f});b=e;d=f;break;case "H":e=+a.shift();g&&(e+=b);c.push({cmd:"line",x1:b,y1:d,x2:e,y2:d});b=e;break;case "V":f=+a.shift();g&&(f+=d);c.push({cmd:"line",x1:b,y1:d,x2:b,y2:f});d=f;break;case "Z":h&&(c.push({cmd:"line",x1:b,y1:d,x2:h.x,y2:h.y}),b=h.x,d=h.y);k=h=null;break;case "C":var m=+a.shift(),l=+a.shift(),
q=+a.shift(),p=+a.shift();e=+a.shift();f=+a.shift();g&&(m+=b,l+=d,q+=b,p+=d,e+=b,f+=d);c.push({cmd:"cubic",x0:b,y0:d,x1:m,y1:l,x2:q,y2:p,x3:e,y3:f,bezier:new Bezier(b,d,m,l,q,p,e,f)});b=e;d=f;break;case "S":"C"!==e&&"S"!==e?(m=b,l=d):(m=b+b-c[c.length-1].x2,l=d+d-c[c.length-1].y2);q=+a.shift();p=+a.shift();e=+a.shift();f=+a.shift();g&&(q+=b,p+=d,e+=b,f+=d);c.push({cmd:"cubic",x0:b,y0:d,x1:m,y1:l,x2:q,y2:p,x3:e,y3:f,bezier:new Bezier(b,d,m,l,q,p,e,f)});b=e;d=f;break;case "Q":m=+a.shift();l=+a.shift();
e=+a.shift();f=+a.shift();g&&(m+=b,l+=d,e+=b,f+=d);c.push({cmd:"quadratic",x0:b,y0:d,x1:m,y1:l,x2:e,y2:f,bezier:new Bezier(b,d,m,l,e,f)});b=e;d=f;break;case "T":"Q"!==e&&"T"!==e?(m=b,l=d):(m=b+b-c[c.length-1].x1,l=d+d-c[c.length-1].y1);e=+a.shift();f=+a.shift();g&&(e+=b,f+=d);c.push({cmd:"quadratic",x0:b,y0:d,x1:m,y1:l,x2:e,y2:f,bezier:new Bezier(b,d,m,l,e,f)});b=e;d=f;break;case "A":m=+a.shift();l=+a.shift();q=+a.shift();p=+a.shift();var w=+a.shift();e=+a.shift();f=+a.shift();g&&(e+=b,f+=d);c.push({cmd:"arc",
rx:m,ry:l,axisRotation:q,largeArcFlag:p,sweepFlag:w,x:e,y:f});b=e;d=f;break;default:throw Error("Invalid SVG command "+k);}}return c}function y(a){this.platform=a;this.orientation=Quaternion.ONE;this.translation=[0,0,0];this.start("wobble")}function z(){}y.SVG=function(a,c){function b(a,b,e){var f=(a-c.x)/c.width*80-40,k=(b-c.y)/c.height*80-40;h.push({orig:g.cmd,x:f,y:k,z:e,t:Math.hypot(f-((d.x-c.x)/c.width*80-40),k-((d.y-c.y)/c.height*80-40),e-d.z)/.05});d.x=a;d.y=b;d.z=e}for(var d={x:c.width/2,
y:c.height/2,z:0},h=[],k=E(a),e=0;e<k.length;e++){var g=k[e];switch(g.cmd){case "move":b(d.x,d.y,-10);b(g.x,g.y,-10);b(g.x,g.y,0);break;case "line":b(g.x2,g.y2,0);break;case "quadratic":case "cubic":for(var f=g.bezier.getLUT(),m=0;m<f.length;m++)b(f[m].x,f[m].y,0);break;case "arc":var l=d.x,q=d.y,p=g.x,w=g.y;f=g.axisRotation;m=g.sweepFlag;var u=g.rx,t=g.ry,n=Math.cos(f)*(l-p)/2+Math.sin(f)*(q-w)/2,r=-Math.sin(f)*(l-p)/2+Math.cos(f)*(q-w)/2;g=(g.largeArcFlag===m?-1:1)*Math.sqrt((u*u*t*t-u*u*r*r-t*
t*n*n)/(u*u*r*r+t*t*n*n));var x=g*u*r/t,v=g*-t*n/u;l=(l+p)/2+Math.cos(f)*x-Math.sin(f)*v;q=(q+w)/2+Math.sin(f)*x+Math.cos(f)*v;p=function(a,b,d,c){return(a*c<b*d?-1:1)*Math.acos((a*d+b*c)/Math.sqrt((a*a+b*b)*(d*d+c*c)))};w=p(1,0,(n-x)/u,(r-v)/t);n=p((n-x)/u,(r-v)/t,(-n-x)/u,(-r-v)/t);0===m&&0<n?n-=2*Math.PI:1===m&&0>n&&(n+=2*Math.PI);r=Math.ceil(Math.abs(n*Math.max(u,t))/2);for(m=0;m<=r;m++)v=w+m/r*n,x=u*Math.cos(v),v=t*Math.sin(v),b(l+(x*Math.cos(f)-v*Math.sin(f)),q+(x*Math.sin(f)+v*Math.cos(f)),
0)}}return y.Interpolate(h)};y.Interpolate=function(a){for(var c=0,b=1;b<a.length;b++)c+=a[b].t;return{duration:c,pathVisible:!0,next:null,fn:function(b){this.orientation=Quaternion.ONE;for(var d=0,k=1;k<a.length;k++){var e=a[k],g=d+e.t/c;if(d<=b&&b<g){b=(b-d)/(g-d);k=0===k?a[0]:a[k-1];this.translation[0]=k.x+(e.x-k.x)*b;this.translation[1]=k.y+(e.y-k.y)*b;this.translation[2]=k.z+(e.z-k.z)*b;return}d=g}this.translation[0]=a[a.length-1].x;this.translation[1]=a[a.length-1].y;this.translation[2]=a[a.length-
1].z}}};y.prototype={cur:null,next:null,startTime:0,platform:null,translation:null,orientation:null,pathVisible:!0,toggleVisiblePath:function(){this.pathVisible=!this.pathVisible},drawPath:function(a){if(this.pathVisible&&this.cur.pathVisible){a.beginShape();a.noFill();a.stroke(255,0,0);for(var c=0;100>=c;c++)this.cur.fn.call(this,c/100,a),a.vertex(this.translation[0],this.translation[1],this.translation[2]+this.platform.T0[2]);a.endShape()}},start:function(a){this.map[a]&&(a=this.map[a]);this.fn[a]?
this._start(this.fn[a],this.fn[a].next):console.log("Failed ",a)},_start:function(a,c){a.start&&a.start.call(this);this.cur=a;this.next=c;this.startTime=Date.now()},moveTo:function(a,c,b,d){var h=this.translation.slice();this.orientation.clone();this.cur={duration:b,pathVisible:!1,fn:function(b){this.orientation=c;this.translation=[h[0]+b*(a[0]-h[0]),h[1]+b*(a[1]-h[1]),h[2]+b*(a[2]-h[2])]}};this.startTime=Date.now();this.next=d},update:function(a){var c=(Date.now()-this.startTime)/this.cur.duration;
1<c&&(c=1);this.cur.fn.call(this,c,a);1===c&&0!==this.cur.duration&&null!==this.next&&this.start(this.next);this.platform.update(this.translation,this.orientation)},fn:{rotate:{duration:4E3,pathVisible:!1,next:"rotate",fn:function(a){a=Math.pow(Math.sin(a*Math.PI*2-8*Math.PI),5)/2;this.translation[0]=0;this.translation[1]=0;this.translation[2]=0;this.orientation=Quaternion.fromAxisAngle([0,0,1],a)}},tilt:{duration:7E3,pathVisible:!1,next:"tilt",fn:function(a){var c=0,b=0;.25>a?(a*=4,c=0):.5>a?(a=
4*(a-.25),c=1*Math.PI/3):.75>a?(a=4*(a-.5),c=2*Math.PI/3):(a=4*(a-.75),b=1);var d=0,h=0;0===b&&(d=Math.sin(c),h=-Math.cos(c));a=Math.pow(Math.sin(a*Math.PI*2-8*Math.PI),5)/3;this.translation[0]=0;this.translation[1]=0;this.translation[2]=0;this.orientation=Quaternion.fromAxisAngle([d,h,b],a)}},square:function(){var a=y.Interpolate([{x:-30,y:-30,z:10,t:0},{x:-30,y:30,z:0,t:1E3},{x:30,y:30,z:10,t:1E3},{x:30,y:-30,z:0,t:1E3},{x:-30,y:-30,z:10,t:1E3}]);a.next="square";return a}(),wobble:{duration:3E3,
pathVisible:!1,next:"wobble",fn:function(a){a=2*a*Math.PI;this.translation[0]=13*Math.cos(-a);this.translation[1]=13*Math.sin(-a);this.translation[2]=0;this.orientation=(new Quaternion(-13,-Math.cos(a),Math.sin(a),0)).normalize()}},breathe:{duration:5E3,pathVisible:!1,next:"breathe",fn:function(a){this.translation=[0,0,Math.exp(Math.sin(2*Math.PI*a)-1)/(Math.E*Math.E-1)*50];this.orientation=Quaternion.ONE}},eight:{duration:3500,pathVisible:!0,next:"eight",fn:function(a){a=(-.5+2*a)*Math.PI;this.translation=
[30*Math.cos(a),Math.sin(a)*Math.cos(a)*30,0];this.orientation=Quaternion.ONE}},lissajous:{duration:1E4,pathVisible:!0,next:"lissajous",fn:function(a){this.translation=[30*Math.sin(6*a*Math.PI),30*Math.sin(4*a*Math.PI),0];this.orientation=Quaternion.ONE}},helical:{duration:5E3,pathVisible:!0,next:null,fn:function(a){a=1-a;this.translation=[20*Math.cos(a*Math.PI*8),20*Math.sin(a*Math.PI*8),20*a];this.orientation=Quaternion.ONE}},mouse:{duration:0,pathVisible:!1,next:null,fn:function(a,c){this.translation=
[(c.mouseX-512)/10,(c.mouseY-382)/10,0];this.orientation=Quaternion.ONE}},gamepad:function(){var a=!1;A.addEventListener&&(A.addEventListener("gamepadconnected",function(c){a=!0}),A.addEventListener("gamepaddisconnected",function(c){a=!1}));return{duration:0,pathVisible:!1,next:null,start:function(){this.orientation=Quaternion.ONE;this.translation=[0,0,0];a?alert("Use the joysticks and L1 button"):alert("Plug in a Playstation or Xbox controller and use the joysticks")},fn:function(){if(a){var c=navigator.getGamepads?
navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[],b=c[0].axes;c[0].buttons[6].value?(this.orientation=Quaternion.fromAxisAngle([0,0,1],-b[3]*Math.PI/6),this.translation=[0,0,0]):(c=Math.atan2(-b[3],-b[2]),this.translation=[30*b[1],30*b[0],0],this.orientation=(new Quaternion(-13,-Math.cos(c),Math.sin(c),0)).normalize())}}}}()},map:{q:"square",w:"wobble",e:"eight",r:"rotate",t:"tilt",y:"lissajous",m:"mouse",g:"gamepad",b:"breathe",h:"helical",p:"perlin"}};z.prototype=
{translation:null,orientation:null,drawBasePlate:null,drawPlatformPlate:null,rodLength:0,hornLength:0,hornDirection:0,servoRange:null,servoRangeVisible:!1,sinBeta:[],cosBeta:[],B:[],P:[],q:[],l:[],H:[],T0:[],init:function(a){this.rodLength=a.rodLength;this.hornLength=a.hornLength;this.hornDirection=a.hornDirection;this.drawBasePlate=a.drawBasePlate;this.drawPlatformPlate=a.drawPlatformPlate;this.servoRange=a.servoRange;this.servoRangeVisible=a.servoRangeVisible;this.B=[];this.P=[];this.q=[];this.l=
[];this.H=[];this.sinBeta=[];this.cosBeta=[];for(var c=a.getLegs.call(this),b=0;b<c.length;b++)this.B.push(c[b].baseJoint),this.P.push(c[b].platformJoint),this.sinBeta.push(Math.sin(c[b].motorRotation)),this.cosBeta.push(Math.cos(c[b].motorRotation)),this.q.push([0,0,0]),this.l.push([0,0,0]),this.H.push([0,0,0]);this.T0=a.absoluteHeight?[0,0,0]:[0,0,Math.sqrt(this.rodLength*this.rodLength+this.hornLength*this.hornLength-Math.pow(this.P[0][0]-this.B[0][0],2)-Math.pow(this.P[0][1]-this.B[0][1],2))]},
initCircular:function(a){a||(a={});var c=a.baseRadius||80,b=a.platformRadius||50,d=(a.shaftDistance||20)/c,h=(a.anchorDistance||20)/c,k=a.hornDirection||0;this.init({rodLength:a.rodLength||130,hornLength:a.hornLength||50,hornDirection:k,servoRange:a.servoRange||[-Math.PI/2,Math.PI/2],servoRangeVisible:void 0===a.servoRangeVisible?!1:a.servoRangeVisible,getLegs:function(){for(var a=[],g=0;6>g;g++){var f=Math.pow(-1,g),m=(g+g%2)*Math.PI/3+f*d/2;f=(1+g-g%2)*Math.PI/3-f*h/2;a.push({baseJoint:[Math.cos(m)*
c,Math.sin(m)*c,0],platformJoint:[Math.cos(f)*b,Math.sin(f)*b,0],motorRotation:m+(g+k)%2*Math.PI+Math.PI/2})}return a},drawBasePlate:function(a){a.stroke(0);a.fill(254,241,53);a.ellipse(0,0,2*c,2*c)},drawPlatformPlate:function(a){a.stroke(0);a.fill(42,236,253);a.ellipse(0,0,2*b,2*b)}})},initHexagonal:function(a){a||(a={});var c=a.platformRadius||50,b=a.platformRadiusOuter||80,d=void 0===a.platformTurn?!0:a.platformTurn,h=a.rodLength||130,k=a.hornLength||50,e=a.hornDirection||0,g=a.shaftDistance||
20,f=a.anchorDistance||20,m=D(a.baseRadius||80,a.baseRadiusOuter||110,0),l=D(c,b,d?Math.PI:0);this.init({rodLength:h,hornLength:k,hornDirection:e,servoRange:a.servoRange||[-Math.PI/2,Math.PI/2],servoRangeVisible:void 0===a.servoRangeVisible?!1:a.servoRangeVisible,getLegs:function(){for(var a=[],b=[],c=[],k=[],h=0;6>h;h++){var n=h|1,r=m[n].x,x=m[n].y,v=m[(n+1)%6].x,z=m[(n+1)%6].y,B=v-r,y=z-x,A=Math.hypot(B,y),C=Math.pow(-1,h);r=(r+v)/2;x=(x+z)/2;z=(l[n].x+l[(n+1)%6].x)/2;n=(l[n].y+l[(n+1)%6].y)/2;
B/=A;y/=A;b.push([r+B*g*C,x+y*g*C,0]);c.push([z+B*f*C,n+y*f*C,0]);k.push(Math.atan2(y,B)+(h+e)%2*Math.PI)}B=[0,1,2,3,4,5];d&&(B=[4,3,0,5,2,1]);for(h=0;h<b.length;h++)a.push({baseJoint:b[h],platformJoint:c[B[h]],motorRotation:k[h]});return a},drawBasePlate:function(a){a.stroke(0);a.fill(254,241,53);a.beginShape();for(var b=0;b<m.length;b++)a.vertex(m[b].x,m[b].y);a.endShape(a.CLOSE)},drawPlatformPlate:function(a){a.stroke(0);a.fill(42,236,253);a.beginShape();for(var b=0;b<l.length;b++)a.vertex(l[b].x,
l[b].y);a.endShape(a.CLOSE)}})},draw:function(){function a(a,d,c){var b=0,e=2*Math.PI/12;a.beginShape(a.TRIANGLE_STRIP);for(var g=0;12>=g;g++)a.vertex(0,0,0),a.vertex(d*Math.cos(b),c,d*Math.sin(b)),b+=e;a.endShape();b=0;a.beginShape(a.TRIANGLE_FAN);a.vertex(0,c,0);for(g=0;13>g;g++)a.vertex(d*Math.cos(b),c,d*Math.sin(b)),b+=e;a.endShape()}function c(b){b.push();b.strokeWeight(2);b.stroke(255,0,0);b.line(0,0,0,40,0,0);b.stroke(0,255,0);b.line(0,0,0,0,40,0);b.stroke(0,0,255);b.line(0,0,0,0,0,40);b.pop();
b.push();b.noStroke();b.fill(255,0,0);b.rotateZ(Math.PI/2);b.translate(0,-50,0);a(b,3,10);b.pop();b.push();b.noStroke();b.fill(0,255,0);b.rotateX(-Math.PI);b.translate(0,-50,0);a(b,3,10);b.pop();b.push();b.noStroke();b.fill(0,0,255);b.rotateX(-Math.PI/2);b.translate(0,-50,0);a(b,3,10);b.pop()}return function(a){c(a);a.push();this.drawBasePlate.call(this,a);a.translate(this.translation[0],this.translation[1],this.translation[2]+this.T0[2]);if(1>this.orientation.w){var b=Math.sqrt(1-this.orientation.w*
this.orientation.w);a.rotate(2*Math.acos(this.orientation.w),[this.orientation.x/b,this.orientation.y/b,this.orientation.z/b])}this.drawPlatformPlate.call(this,a);c(a);a.pop();for(b=0;b<this.B.length;b++)a.push(),a.translate(this.B[b][0],this.B[b][1],this.B[b][2]),a.noStroke(),a.fill(0),a.sphere(3),a.pop(),a.push(),a.translate(this.q[b][0],this.q[b][1],this.q[b][2]),a.noStroke(),a.fill(255,0,0),a.sphere(3),a.pop(),a.push(),a.stroke(255,0,0),a.strokeWeight(1),a.line(this.H[b][0],this.H[b][1],this.H[b][2],
this.q[b][0],this.q[b][1],this.q[b][2]),a.stroke(0),a.line(this.B[b][0],this.B[b][1],this.B[b][2],this.H[b][0],this.H[b][1],this.H[b][2]),a.pop(),this.servoRangeVisible&&(a.push(),a.translate(this.B[b][0],this.B[b][1],this.B[b][2]),a.rotateX(Math.PI/2),a.rotateY(Math.atan2(this.H[b][1]-this.B[b][1],this.H[b][0]-this.B[b][0])),a.fill("rgba(255,0,0,0.1)"),a.noStroke(),a.arc(0,0,2*this.hornLength,2*this.hornLength,this.servoRange[0],this.servoRange[1],a.PIE),a.pop())}}(),update:function(a,c){var b=this.hornLength,
d=this.rodLength,h=this.q,k=this.l,e=this.B,g=this.P,f=this.H,m=this.T0[2];this.translation=a;this.orientation=c;for(var l=0;l<e.length;l++){var q=c.rotateVector(g[l]),p=k[l],w=h[l],u=f[l],t=e[l];w[0]=a[0]+q[0];w[1]=a[1]+q[1];w[2]=a[2]+q[2]+m;p[0]=h[l][0]-t[0];p[1]=h[l][1]-t[1];p[2]=h[l][2]-t[2];q=p[0]*p[0]+p[1]*p[1]+p[2]*p[2]-d*d+b*b;w=2*b*k[2][2];var n=2*b*(this.cosBeta[l]*p[0]+this.sinBeta[l]*p[1]),r=w*w+n*n,x=Math.sqrt(1-q*q/r),v=Math.sqrt(r);p=q*w/r-n*x/v;q=q*n/r+w*x/v;u[0]=t[0]+b*q*this.cosBeta[l];
u[1]=t[1]+b*q*this.sinBeta[l];u[2]=t[2]+b*p}},getServoAngles:function(){for(var a=[],c=0;c<this.B.length;c++)a[c]=Math.asin((this.H[c][2]-this.B[c][2])/this.hornLength),isNaN(a[c])?a[c]=null:this.servoRange[0]<=a[c]&&a[c]<=this.servoRange[1]||(a[c]=null);return a}};"object"===typeof exports?(Object.defineProperty(exports,"__esModule",{value:!0}),z["default"]=z,z.Stewart=z,z.Animation=y,module.exports=z):(A.Animation=y,A.Stewart=z)})(this);