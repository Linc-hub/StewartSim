/*
Stewart.js v1.0.1 17/02/2019
https://raw.org/research/inverse-kinematics-of-a-stewart-platform/

Copyright (c) 2019, Robert Eisele (robert@raw.org)
Dual licensed under the MIT or GPL Version 2 licenses.
*/
(function(F){function G(a,d,b){var c=[];a=(2*a-d)/Math.sqrt(3);for(var p=0;6>p;p++){var h=(p-p%2)/3*Math.PI+b,e=a*Math.pow(-1,p);c.push({x:d*Math.cos(h)+e*Math.sin(h),y:d*Math.sin(h)-e*Math.cos(h)})}return c}function H(a){a=a.match(/[a-z]|[-+]?([0-9]*\.[0-9]+|[0-9]+)/ig);for(var d=[],b=0,c=0,p=null,h=null,e,g=!1;0<a.length;){if(-1!=="MmZzLlHhVvCcSsQqTtAa".indexOf(a[0]))e=h,h=a.shift(),g=-1==="MZLHVCSQTA".indexOf(h),h=h.toUpperCase();else{if(null===h)throw Error("Invalid implicit command");e=h}switch(h){case "M":e=
+a.shift();var f=+a.shift();g?(b+=e,c+=f):(b=e,c=f);d.push({cmd:"move",x:e,y:f});p={x:b,y:c};h="L";break;case "L":e=+a.shift();f=+a.shift();g&&(e+=b,f+=c);d.push({cmd:"line",x1:b,y1:c,x2:e,y2:f});b=e;c=f;break;case "H":e=+a.shift();g&&(e+=b);d.push({cmd:"line",x1:b,y1:c,x2:e,y2:c});b=e;break;case "V":f=+a.shift();g&&(f+=c);d.push({cmd:"line",x1:b,y1:c,x2:b,y2:f});c=f;break;case "Z":p&&(d.push({cmd:"line",x1:b,y1:c,x2:p.x,y2:p.y}),b=p.x,c=p.y);h=p=null;break;case "C":var l=+a.shift(),n=+a.shift(),
m=+a.shift(),k=+a.shift();e=+a.shift();f=+a.shift();g&&(l+=b,n+=c,m+=b,k+=c,e+=b,f+=c);d.push({cmd:"cubic",x0:b,y0:c,x1:l,y1:n,x2:m,y2:k,x3:e,y3:f,bezier:new Bezier(b,c,l,n,m,k,e,f)});b=e;c=f;break;case "S":"C"!==e&&"S"!==e?(l=b,n=c):(l=b+b-d[d.length-1].x2,n=c+c-d[d.length-1].y2);m=+a.shift();k=+a.shift();e=+a.shift();f=+a.shift();g&&(m+=b,k+=c,e+=b,f+=c);d.push({cmd:"cubic",x0:b,y0:c,x1:l,y1:n,x2:m,y2:k,x3:e,y3:f,bezier:new Bezier(b,c,l,n,m,k,e,f)});b=e;c=f;break;case "Q":l=+a.shift();n=+a.shift();
e=+a.shift();f=+a.shift();g&&(l+=b,n+=c,e+=b,f+=c);d.push({cmd:"quadratic",x0:b,y0:c,x1:l,y1:n,x2:e,y2:f,bezier:new Bezier(b,c,l,n,e,f)});b=e;c=f;break;case "T":"Q"!==e&&"T"!==e?(l=b,n=c):(l=b+b-d[d.length-1].x1,n=c+c-d[d.length-1].y1);e=+a.shift();f=+a.shift();g&&(e+=b,f+=c);d.push({cmd:"quadratic",x0:b,y0:c,x1:l,y1:n,x2:e,y2:f,bezier:new Bezier(b,c,l,n,e,f)});b=e;c=f;break;case "A":l=+a.shift();n=+a.shift();m=+a.shift();k=+a.shift();var t=+a.shift();e=+a.shift();f=+a.shift();g&&(e+=b,f+=c);d.push({cmd:"arc",
rx:l,ry:n,axisRotation:m,largeArcFlag:k,sweepFlag:t,x:e,y:f});b=e;c=f;break;default:throw Error("Invalid SVG command "+h);}}return d}function D(a){this.platform=a;this.orientation=Quaternion.ONE;this.translation=[0,0,0];this.start("wobble")}function C(){}D.SVG=function(a,d){function b(A,x,z){var B=(A-d.x)/d.width*80-40,E=(x-d.y)/d.height*80-40;p.push({orig:g.cmd,x:B,y:E,z:z,t:Math.hypot(B-((c.x-d.x)/d.width*80-40),E-((c.y-d.y)/d.height*80-40),z-c.z)/.05});c.x=A;c.y=x;c.z=z}for(var c={x:d.width/2,
y:d.height/2,z:0},p=[],h=H(a),e=0;e<h.length;e++){var g=h[e];switch(g.cmd){case "move":b(c.x,c.y,-10);b(g.x,g.y,-10);b(g.x,g.y,0);break;case "line":b(g.x2,g.y2,0);break;case "quadratic":case "cubic":for(var f=g.bezier.getLUT(),l=0;l<f.length;l++)b(f[l].x,f[l].y,0);break;case "arc":var n=c.x,m=c.y,k=g.x,t=g.y;f=g.axisRotation;l=g.sweepFlag;var v=g.rx,q=g.ry,r=Math.cos(f)*(n-k)/2+Math.sin(f)*(m-t)/2,u=-Math.sin(f)*(n-k)/2+Math.cos(f)*(m-t)/2;g=(g.largeArcFlag===l?-1:1)*Math.sqrt((v*v*q*q-v*v*u*u-q*
q*r*r)/(v*v*u*u+q*q*r*r));var y=g*v*u/q,w=g*-q*r/v;n=(n+k)/2+Math.cos(f)*y-Math.sin(f)*w;m=(m+t)/2+Math.sin(f)*y+Math.cos(f)*w;k=function(A,x,z,B){return(A*B<x*z?-1:1)*Math.acos((A*z+x*B)/Math.sqrt((A*A+x*x)*(z*z+B*B)))};t=k(1,0,(r-y)/v,(u-w)/q);r=k((r-y)/v,(u-w)/q,(-r-y)/v,(-u-w)/q);0===l&&0<r?r-=2*Math.PI:1===l&&0>r&&(r+=2*Math.PI);u=Math.ceil(Math.abs(r*Math.max(v,q))/2);for(l=0;l<=u;l++)w=t+l/u*r,y=v*Math.cos(w),w=q*Math.sin(w),b(n+(y*Math.cos(f)-w*Math.sin(f)),m+(y*Math.sin(f)+w*Math.cos(f)),
0)}}return D.Interpolate(p)};D.Interpolate=function(a){for(var d=0,b=1;b<a.length;b++)d+=a[b].t;return{duration:d,pathVisible:!0,next:null,fn:function(c){this.orientation=Quaternion.ONE;for(var p=0,h=1;h<a.length;h++){var e=a[h],g=p+e.t/d;if(p<=c&&c<g){c=(c-p)/(g-p);h=0===h?a[0]:a[h-1];this.translation[0]=h.x+(e.x-h.x)*c;this.translation[1]=h.y+(e.y-h.y)*c;this.translation[2]=h.z+(e.z-h.z)*c;return}p=g}this.translation[0]=a[a.length-1].x;this.translation[1]=a[a.length-1].y;this.translation[2]=a[a.length-
1].z}}};D.prototype={cur:null,next:null,startTime:0,platform:null,translation:null,orientation:null,pathVisible:!0,toggleVisiblePath:function(){this.pathVisible=!this.pathVisible},drawPath:function(a){if(this.pathVisible&&this.cur.pathVisible){a.beginShape();a.noFill();a.stroke(255,0,0);for(var d=0;100>=d;d++)this.cur.fn.call(this,d/100,a),a.vertex(this.translation[0],this.translation[1],this.translation[2]+this.platform.T0[2]);a.endShape()}},start:function(a){this.map[a]&&(a=this.map[a]);this.fn[a]?
this._start(this.fn[a],this.fn[a].next):console.log("Failed ",a)},_start:function(a,d){a.start&&a.start.call(this);this.cur=a;this.next=d;this.startTime=Date.now()},moveTo:function(a,d,b,c){var p=this.translation.slice(),h=this.orientation.clone().slerp(d);this.cur={duration:b,pathVisible:!1,fn:function(e){this.orientation=h(e);this.translation=[p[0]+e*(a[0]-p[0]),p[1]+e*(a[1]-p[1]),p[2]+e*(a[2]-p[2])]}};this.startTime=Date.now();this.next=c},update:function(a){var d=(Date.now()-this.startTime)/this.cur.duration;
1<d&&(d=1);this.cur.fn.call(this,d,a);1===d&&0!==this.cur.duration&&null!==this.next&&this.start(this.next);this.platform.update(this.translation,this.orientation)},fn:{rotate:{duration:4E3,pathVisible:!1,next:"rotate",fn:function(a){a=Math.pow(Math.sin(a*Math.PI*2-8*Math.PI),5)/2;this.translation[0]=0;this.translation[1]=0;this.translation[2]=0;this.orientation=Quaternion.fromAxisAngle([0,0,1],a)}},tilt:{duration:7E3,pathVisible:!1,next:"tilt",fn:function(a){var d=0,b=0;.25>a?(a*=4,d=0):.5>a?(a=
4*(a-.25),d=1*Math.PI/3):.75>a?(a=4*(a-.5),d=2*Math.PI/3):(a=4*(a-.75),b=1);var c=0,p=0;0===b&&(c=Math.sin(d),p=-Math.cos(d));a=Math.pow(Math.sin(a*Math.PI*2-8*Math.PI),5)/3;this.translation[0]=0;this.translation[1]=0;this.translation[2]=0;this.orientation=Quaternion.fromAxisAngle([c,p,b],a)}},square:function(){var a=D.Interpolate([{x:-30,y:-30,z:10,t:0},{x:-30,y:30,z:0,t:1E3},{x:30,y:30,z:10,t:1E3},{x:30,y:-30,z:0,t:1E3},{x:-30,y:-30,z:10,t:1E3}]);a.next="square";return a}(),wobble:{duration:3E3,
pathVisible:!1,next:"wobble",fn:function(a){a=2*a*Math.PI;this.translation[0]=13*Math.cos(-a);this.translation[1]=13*Math.sin(-a);this.translation[2]=0;this.orientation=(new Quaternion(-13,-Math.cos(a),Math.sin(a),0)).normalize()}},breathe:{duration:5E3,pathVisible:!1,next:"breathe",fn:function(a){this.translation=[0,0,Math.exp(Math.sin(2*Math.PI*a)-1)/(Math.E*Math.E-1)*50];this.orientation=Quaternion.ONE}},eight:{duration:3500,pathVisible:!0,next:"eight",fn:function(a){a=(-.5+2*a)*Math.PI;this.translation=
[30*Math.cos(a),Math.sin(a)*Math.cos(a)*30,0];this.orientation=Quaternion.ONE}},lissajous:{duration:1E4,pathVisible:!0,next:"lissajous",fn:function(a){this.translation=[30*Math.sin(6*a*Math.PI),30*Math.sin(4*a*Math.PI),0];this.orientation=Quaternion.ONE}},helical:{duration:5E3,pathVisible:!0,next:null,fn:function(a){a=1-a;this.translation=[20*Math.cos(a*Math.PI*8),20*Math.sin(a*Math.PI*8),20*a];this.orientation=Quaternion.ONE}},mouse:{duration:0,pathVisible:!1,next:null,fn:function(a,d){this.translation=
[(d.mouseX-512)/10,(d.mouseY-382)/10,0];this.orientation=Quaternion.ONE}},gamepad:function(){var a=!1;F.addEventListener&&(F.addEventListener("gamepadconnected",function(d){a=!0}),F.addEventListener("gamepaddisconnected",function(d){a=!1}));return{duration:0,pathVisible:!1,next:null,start:function(){this.orientation=Quaternion.ONE;this.translation=[0,0,0];a?alert("Use the joysticks and L1 button"):alert("Plug in a Playstation or Xbox controller and use the joysticks")},fn:function(){if(a){var d=navigator.getGamepads?
navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[],b=d[0].axes;d[0].buttons[6].value?(this.orientation=Quaternion.fromAxisAngle([0,0,1],-b[3]*Math.PI/6),this.translation=[0,0,0]):(d=Math.atan2(-b[3],-b[2]),this.translation=[30*b[1],30*b[0],0],this.orientation=(new Quaternion(-13,-Math.cos(d),Math.sin(d),0)).normalize())}}}}()},map:{q:"square",w:"wobble",e:"eight",r:"rotate",t:"tilt",y:"lissajous",m:"mouse",g:"gamepad",b:"breathe",h:"helical",p:"perlin"}};C.prototype=
{translation:null,orientation:null,drawBasePlate:null,drawPlatformPlate:null,rodLength:0,hornLength:0,hornDirection:0,servoRange:null,servoRangeVisible:!1,sinBeta:[],cosBeta:[],B:[],P:[],q:[],l:[],H:[],T0:[],init:function(a){this.rodLength=a.rodLength;this.hornLength=a.hornLength;this.hornDirection=a.hornDirection;this.drawBasePlate=a.drawBasePlate;this.drawPlatformPlate=a.drawPlatformPlate;this.servoRange=a.servoRange;this.servoRangeVisible=a.servoRangeVisible;this.B=[];this.P=[];this.q=[];this.l=
[];this.H=[];this.sinBeta=[];this.cosBeta=[];for(var d=a.getLegs.call(this),b=0;b<d.length;b++)this.B.push(d[b].baseJoint),this.P.push(d[b].platformJoint),this.sinBeta.push(Math.sin(d[b].motorRotation)),this.cosBeta.push(Math.cos(d[b].motorRotation)),this.q.push([0,0,0]),this.l.push([0,0,0]),this.H.push([0,0,0]);this.T0=a.absoluteHeight?[0,0,0]:[0,0,Math.sqrt(this.rodLength*this.rodLength+this.hornLength*this.hornLength-Math.pow(this.P[0][0]-this.B[0][0],2)-Math.pow(this.P[0][1]-this.B[0][1],2))]},
initCircular:function(a){a||(a={});var d=a.baseRadius||80,b=a.platformRadius||50,c=(a.shaftDistance||20)/d,p=(a.anchorDistance||20)/d,h=a.hornDirection||0;this.init({rodLength:a.rodLength||130,hornLength:a.hornLength||50,hornDirection:h,servoRange:a.servoRange||[-Math.PI/2,Math.PI/2],servoRangeVisible:void 0===a.servoRangeVisible?!1:a.servoRangeVisible,getLegs:function(){for(var e=[],g=0;6>g;g++){var f=Math.pow(-1,g),l=(g+g%2)*Math.PI/3+f*c/2;f=(1+g-g%2)*Math.PI/3-f*p/2;e.push({baseJoint:[Math.cos(l)*
d,Math.sin(l)*d,0],platformJoint:[Math.cos(f)*b,Math.sin(f)*b,0],motorRotation:l+(g+h)%2*Math.PI+Math.PI/2})}return e},drawBasePlate:function(e){e.stroke(0);e.fill(254,241,53);e.ellipse(0,0,2*d,2*d)},drawPlatformPlate:function(e){e.stroke(0);e.fill(42,236,253);e.ellipse(0,0,2*b,2*b)}})},initHexagonal:function(a){a||(a={});var d=a.platformRadius||50,b=a.platformRadiusOuter||80,c=void 0===a.platformTurn?!0:a.platformTurn,p=a.rodLength||130,h=a.hornLength||50,e=a.hornDirection||0,g=a.shaftDistance||
20,f=a.anchorDistance||20,l=G(a.baseRadius||80,a.baseRadiusOuter||110,0),n=G(d,b,c?Math.PI:0);this.init({rodLength:p,hornLength:h,hornDirection:e,servoRange:a.servoRange||[-Math.PI/2,Math.PI/2],servoRangeVisible:void 0===a.servoRangeVisible?!1:a.servoRangeVisible,getLegs:function(){for(var m=[],k=[],t=[],v=[],q=0;6>q;q++){var r=q|1,u=l[r].x,y=l[r].y,w=l[(r+1)%6].x,A=l[(r+1)%6].y,x=w-u,z=A-y,B=Math.hypot(x,z),E=Math.pow(-1,q);u=(u+w)/2;y=(y+A)/2;A=(n[r].x+n[(r+1)%6].x)/2;r=(n[r].y+n[(r+1)%6].y)/2;
x/=B;z/=B;k.push([u+x*g*E,y+z*g*E,0]);t.push([A+x*f*E,r+z*f*E,0]);v.push(Math.atan2(z,x)+(q+e)%2*Math.PI)}x=[0,1,2,3,4,5];c&&(x=[4,3,0,5,2,1]);for(q=0;q<k.length;q++)m.push({baseJoint:k[q],platformJoint:t[x[q]],motorRotation:v[q]});return m},drawBasePlate:function(m){m.stroke(0);m.fill(254,241,53);m.beginShape();for(var k=0;k<l.length;k++)m.vertex(l[k].x,l[k].y);m.endShape(m.CLOSE)},drawPlatformPlate:function(m){m.stroke(0);m.fill(42,236,253);m.beginShape();for(var k=0;k<n.length;k++)m.vertex(n[k].x,
n[k].y);m.endShape(m.CLOSE)}})},draw:function(){function a(b,c,p){var h=0,e=2*Math.PI/12;b.beginShape(b.TRIANGLE_STRIP);for(var g=0;12>=g;g++)b.vertex(0,0,0),b.vertex(c*Math.cos(h),p,c*Math.sin(h)),h+=e;b.endShape();h=0;b.beginShape(b.TRIANGLE_FAN);b.vertex(0,p,0);for(g=0;13>g;g++)b.vertex(c*Math.cos(h),p,c*Math.sin(h)),h+=e;b.endShape()}function d(b){b.push();b.strokeWeight(2);b.stroke(255,0,0);b.line(0,0,0,40,0,0);b.stroke(0,255,0);b.line(0,0,0,0,40,0);b.stroke(0,0,255);b.line(0,0,0,0,0,40);b.pop();
b.push();b.noStroke();b.fill(255,0,0);b.rotateZ(Math.PI/2);b.translate(0,-50,0);a(b,3,10);b.pop();b.push();b.noStroke();b.fill(0,255,0);b.rotateX(-Math.PI);b.translate(0,-50,0);a(b,3,10);b.pop();b.push();b.noStroke();b.fill(0,0,255);b.rotateX(-Math.PI/2);b.translate(0,-50,0);a(b,3,10);b.pop()}return function(b){d(b);b.push();this.drawBasePlate.call(this,b);b.translate(this.translation[0],this.translation[1],this.translation[2]+this.T0[2]);b.applyMatrix.apply(b,this.orientation.conjugate().toMatrix4());
this.drawPlatformPlate.call(this,b);d(b);b.pop();for(var c=0;c<this.B.length;c++)b.push(),b.translate(this.B[c][0],this.B[c][1],this.B[c][2]),b.noStroke(),b.fill(0),b.sphere(3),b.pop(),b.push(),b.translate(this.q[c][0],this.q[c][1],this.q[c][2]),b.noStroke(),b.fill(255,0,0),b.sphere(3),b.pop(),b.push(),b.stroke(255,0,0),b.strokeWeight(1),b.line(this.H[c][0],this.H[c][1],this.H[c][2],this.q[c][0],this.q[c][1],this.q[c][2]),b.stroke(0),b.line(this.B[c][0],this.B[c][1],this.B[c][2],this.H[c][0],this.H[c][1],
this.H[c][2]),b.pop(),this.servoRangeVisible&&(b.push(),b.translate(this.B[c][0],this.B[c][1],this.B[c][2]),b.rotateX(Math.PI/2),b.rotateY(Math.atan2(this.H[c][1]-this.B[c][1],this.H[c][0]-this.B[c][0])),b.fill("rgba(255,0,0,0.1)"),b.noStroke(),b.arc(0,0,2*this.hornLength,2*this.hornLength,this.servoRange[0],this.servoRange[1],b.PIE),b.pop())}}(),update:function(a,d){var b=this.hornLength,c=this.rodLength,p=this.q,h=this.l,e=this.B,g=this.P,f=this.H,l=this.T0[2];this.translation=a;this.orientation=
d;for(var n=0;n<e.length;n++){var m=d.rotateVector(g[n]),k=h[n],t=p[n],v=f[n],q=e[n];t[0]=a[0]+m[0];t[1]=a[1]+m[1];t[2]=a[2]+m[2]+l;k[0]=t[0]-q[0];k[1]=t[1]-q[1];k[2]=t[2]-q[2];m=k[0]*k[0]+k[1]*k[1]+k[2]*k[2]-c*c+b*b;t=2*b*k[2];var r=2*b*(this.cosBeta[n]*k[0]+this.sinBeta[n]*k[1]),u=t*t+r*r,y=Math.sqrt(1-m*m/u),w=Math.sqrt(u);k=m*t/u-r*y/w;m=m*r/u+t*y/w;v[0]=q[0]+b*m*this.cosBeta[n];v[1]=q[1]+b*m*this.sinBeta[n];v[2]=q[2]+b*k}},getServoAngles:function(){for(var a=[],d=0;d<this.B.length;d++)a[d]=Math.asin((this.H[d][2]-
this.B[d][2])/this.hornLength),isNaN(a[d])?a[d]=null:this.servoRange[0]<=a[d]&&a[d]<=this.servoRange[1]||(a[d]=null);return a}};"object"===typeof exports?(Object.defineProperty(exports,"__esModule",{value:!0}),C["default"]=C,C.Stewart=C,C.Animation=D,module.exports=C):(F.Animation=D,F.Stewart=C)})(this);
