/*
Stewart v1.2.0 8/30/2025
https://raw.org/research/inverse-kinematics-of-a-stewart-platform/

Copyright (c) 2025, Robert Eisele (https://raw.org/)
Licensed under the MIT license.
*/
'use strict';(function(E){function G(a,d,b){const c=[];a=(2*a-d)/Math.sqrt(3);for(let h=0;6>h;h++){const f=(h-h%2)/3*Math.PI+b,g=a*(h&1?-1:1);c.push({x:d*Math.cos(f)+g*Math.sin(f),y:d*Math.sin(f)-g*Math.cos(f)})}return c}function I(a){a=a.match(/[a-z]|[-+]?([0-9]*\.[0-9]+|[0-9]+)/ig)||[];const d=[];var b=0,c=0,h=null,f=null;let g=!1;for(;0<a.length;){if(-1!=="MmZzLlHhVvCcSsQqTtAa".indexOf(a[0])){var e=f;f=a.shift();g=-1==="MZLHVCSQTA".indexOf(f);f=f.toUpperCase()}else{if(null===f)throw Error("Invalid implicit command");
e=f}switch(f){case "M":h=+a.shift();f=+a.shift();g?(b+=h,c+=f):(b=h,c=f);d.push({cmd:"move",x:b,y:c});h={x:b,y:c};f="L";break;case "L":e=+a.shift();var n=+a.shift();g&&(e+=b,n+=c);d.push({cmd:"line",x1:b,y1:c,x2:e,y2:n});b=e;c=n;break;case "H":e=+a.shift();g&&(e+=b);d.push({cmd:"line",x1:b,y1:c,x2:e,y2:c});b=e;break;case "V":e=+a.shift();g&&(e+=c);d.push({cmd:"line",x1:b,y1:c,x2:b,y2:e});c=e;break;case "Z":h&&(d.push({cmd:"line",x1:b,y1:c,x2:h.x,y2:h.y}),b=h.x,c=h.y);f=h=null;break;case "C":e=+a.shift();
n=+a.shift();var p=+a.shift(),l=+a.shift(),k=+a.shift(),m=+a.shift();g&&(e+=b,n+=c,p+=b,l+=c,k+=b,m+=c);d.push({cmd:"cubic",x0:b,y0:c,x1:e,y1:n,x2:p,y2:l,x3:k,y3:m,bezier:new Bezier(b,c,e,n,p,l,k,m)});b=k;c=m;break;case "S":"C"!==e&&"S"!==e?(e=b,n=c):(e=b+b-d[d.length-1].x2,n=c+c-d[d.length-1].y2);p=+a.shift();l=+a.shift();k=+a.shift();m=+a.shift();g&&(p+=b,l+=c,k+=b,m+=c);d.push({cmd:"cubic",x0:b,y0:c,x1:e,y1:n,x2:p,y2:l,x3:k,y3:m,bezier:new Bezier(b,c,e,n,p,l,k,m)});b=k;c=m;break;case "Q":e=+a.shift();
n=+a.shift();p=+a.shift();l=+a.shift();g&&(e+=b,n+=c,p+=b,l+=c);d.push({cmd:"quadratic",x0:b,y0:c,x1:e,y1:n,x2:p,y2:l,bezier:new Bezier(b,c,e,n,p,l)});b=p;c=l;break;case "T":"Q"!==e&&"T"!==e?(e=b,n=c):(e=b+b-d[d.length-1].x1,n=c+c-d[d.length-1].y1);p=+a.shift();l=+a.shift();g&&(p+=b,l+=c);d.push({cmd:"quadratic",x0:b,y0:c,x1:e,y1:n,x2:p,y2:l,bezier:new Bezier(b,c,e,n,p,l)});b=p;c=l;break;case "A":e=+a.shift();n=+a.shift();p=+a.shift();l=+a.shift();k=+a.shift();m=+a.shift();let q=+a.shift();g&&(m+=
b,q+=c);d.push({cmd:"arc",rx:e,ry:n,axisRotation:p,largeArcFlag:l,sweepFlag:k,x:m,y:q});b=m;c=q;break;default:throw Error("Invalid SVG command "+f);}}return d}function D(a){this.platform=a;this.orientation=Quaternion.ONE;this.translation=[0,0,0];this.start("wobble")}function z(){}const C=2*Math.PI;D.SVG=function(a,d){function b(x,t,y){const v=(x-d.x)/d.width*80-40,A=(t-d.y)/d.height*80-40;h.push({orig:f.cmd,x:v,y:A,z:y,t:Math.hypot(v-((c.x-d.x)/d.width*80-40),A-((c.y-d.y)/d.height*80-40),y-c.z)/.05});
c.x=x;c.y=t;c.z=y}const c={x:d.width/2,y:d.height/2,z:0},h=[];let f=null;a=I(a);for(let x=0;x<a.length;x++)switch(f=a[x],f.cmd){case "move":b(c.x,c.y,-10);b(f.x,f.y,-10);b(f.x,f.y,0);break;case "line":b(f.x2,f.y2,0);break;case "quadratic":case "cubic":var g=f.bezier.getLUT();for(var e=0;e<g.length;e++)b(g[e].x,g[e].y,0);break;case "arc":var n=c.x,p=c.y,l=f.x,k=f.y;g=f.axisRotation;var m=f.sweepFlag;e=f.rx;const t=f.ry;var q=Math.cos(g)*(n-l)/2+Math.sin(g)*(p-k)/2,w=-Math.sin(g)*(n-l)/2+Math.cos(g)*
(p-k)/2,r=(f.largeArcFlag===m?-1:1)*Math.sqrt((e*e*t*t-e*e*w*w-t*t*q*q)/(e*e*w*w+t*t*q*q)),u=r*e*w/t;r=r*-t*q/e;n=(n+l)/2+Math.cos(g)*u-Math.sin(g)*r;p=(p+k)/2+Math.sin(g)*u+Math.cos(g)*r;l=function(y,v,A,B){return(y*B<v*A?-1:1)*Math.acos((y*A+v*B)/Math.sqrt((y*y+v*v)*(A*A+B*B)))};k=l(1,0,(q-u)/e,(w-r)/t);q=l((q-u)/e,(w-r)/t,(-q-u)/e,(-w-r)/t);0===m&&0<q?q-=C:1===m&&0>q&&(q+=C);m=Math.ceil(Math.abs(q*Math.max(e,t))/2);for(w=0;w<=m;w++)r=k+w/m*q,u=e*Math.cos(r),r=t*Math.sin(r),b(n+(u*Math.cos(g)-r*
Math.sin(g)),p+(u*Math.sin(g)+r*Math.cos(g)),0)}return D.Interpolate(h)};D.Interpolate=function(a){let d=0;for(let b=1;b<a.length;b++)d+=a[b].t;return{duration:d,pathVisible:!0,next:null,fn:function(b){this.orientation=Quaternion.ONE;let c=0;for(var h=1;h<a.length;h++){const f=a[h],g=c+f.t/d;if(c<=b&&b<g){b=(b-c)/(g-c);h=0===h?a[0]:a[h-1];this.translation[0]=h.x+(f.x-h.x)*b;this.translation[1]=h.y+(f.y-h.y)*b;this.translation[2]=h.z+(f.z-h.z)*b;return}c=g}this.translation[0]=a[a.length-1].x;this.translation[1]=
a[a.length-1].y;this.translation[2]=a[a.length-1].z}}};D.prototype={cur:null,next:null,startTime:0,platform:null,translation:null,orientation:null,pathVisible:!0,toggleVisiblePath:function(){this.pathVisible=!this.pathVisible},drawPath:function(a){if(this.pathVisible&&this.cur.pathVisible){a.beginShape();a.noFill();a.stroke(255,0,0);for(let d=0;100>=d;d++)this.cur.fn.call(this,d/100,a),a.vertex(this.translation[0],this.translation[1],this.translation[2]+this.platform.T0[2]);a.endShape()}},start:function(a){this.map[a]&&
(a=this.map[a]);this.fn[a]?this._start(this.fn[a],this.fn[a].next):console.log("Failed ",a)},_start:function(a,d){a.start&&a.start.call(this);this.cur=a;this.next=d;this.startTime=Date.now()},moveTo:function(a,d,b,c){const h=this.translation.slice(),f=this.orientation.clone().slerp(d);this.cur={duration:b,pathVisible:!1,fn:function(g){this.orientation=f(g);this.translation=[h[0]+g*(a[0]-h[0]),h[1]+g*(a[1]-h[1]),h[2]+g*(a[2]-h[2])]}};this.startTime=Date.now();this.next=c},update:function(a){let d=
(Date.now()-this.startTime)/this.cur.duration;1<d&&(d=1);this.cur.fn.call(this,d,a);1===d&&0!==this.cur.duration&&null!==this.next&&this.start(this.next);this.platform.update(this.translation,this.orientation)},fn:{rotate:{duration:4E3,pathVisible:!1,next:"rotate",fn:function(a){a=Math.pow(Math.sin(a*Math.PI*2-8*Math.PI),5)/2;this.translation[0]=0;this.translation[1]=0;this.translation[2]=0;this.orientation=Quaternion.fromAxisAngle([0,0,1],a)}},tilt:{duration:7E3,pathVisible:!1,next:"tilt",fn:function(a){let d=
0,b=0;.25>a?(a*=4,d=0):.5>a?(a=4*(a-.25),d=1*Math.PI/3):.75>a?(a=4*(a-.5),d=C/3):(a=4*(a-.75),b=1);let c=0,h=0;0===b&&(c=Math.sin(d),h=-Math.cos(d));a=Math.pow(Math.sin(a*Math.PI*2-8*Math.PI),5)/3;this.translation[0]=0;this.translation[1]=0;this.translation[2]=0;this.orientation=Quaternion.fromAxisAngle([c,h,b],a)}},square:function(){const a=D.Interpolate([{x:-30,y:-30,z:10,t:0},{x:-30,y:30,z:0,t:1E3},{x:30,y:30,z:10,t:1E3},{x:30,y:-30,z:0,t:1E3},{x:-30,y:-30,z:10,t:1E3}]);a.next="square";return a}(),
wobble:{duration:3E3,pathVisible:!1,next:"wobble",fn:function(a){a*=C;this.translation[0]=13*Math.cos(-a);this.translation[1]=13*Math.sin(-a);this.translation[2]=0;this.orientation=(new Quaternion(-13,-Math.cos(a),Math.sin(a),0)).normalize()}},breathe:{duration:5E3,pathVisible:!1,next:"breathe",fn:function(a){this.translation=[0,0,Math.exp(Math.sin(C*a)-1)/(Math.E*Math.E-1)*50];this.orientation=Quaternion.ONE}},eight:{duration:3500,pathVisible:!0,next:"eight",fn:function(a){a=(-.5+2*a)*Math.PI;this.translation=
[30*Math.cos(a),Math.sin(a)*Math.cos(a)*30,0];this.orientation=Quaternion.ONE}},lissajous:{duration:1E4,pathVisible:!0,next:"lissajous",fn:function(a){this.translation=[30*Math.sin(3*a*C),30*Math.sin(2*a*C),0];this.orientation=Quaternion.ONE}},helical:{duration:5E3,pathVisible:!0,next:null,fn:function(a){a=1-a;this.translation=[20*Math.cos(a*Math.PI*8),20*Math.sin(a*Math.PI*8),20*a];this.orientation=Quaternion.ONE}},mouse:{duration:0,pathVisible:!1,next:null,fn:function(a,d){this.translation=[(d.mouseX-
512)/10,(d.mouseY-382)/10,0];this.orientation=Quaternion.ONE}},gamepad:function(){let a=!1;E.addEventListener&&(E.addEventListener("gamepadconnected",function(d){a=!0}),E.addEventListener("gamepaddisconnected",function(d){a=!1}));return{duration:0,pathVisible:!1,next:null,start:function(){this.orientation=Quaternion.ONE;this.translation=[0,0,0];a?alert("Use the joysticks and L1 button"):alert("Plug in a Playstation or Xbox controller and use the joysticks")},fn:function(){if(a){var d=navigator.getGamepads?
navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[],b=d[0].axes;d[0].buttons[6].value?(this.orientation=Quaternion.fromAxisAngle([0,0,1],-b[3]*Math.PI/6),this.translation=[0,0,0]):(d=Math.atan2(-b[3],-b[2]),this.translation=[30*b[1],30*b[0],0],this.orientation=(new Quaternion(-13,-Math.cos(d),Math.sin(d),0)).normalize())}}}}()},map:{q:"square",w:"wobble",e:"eight",r:"rotate",t:"tilt",y:"lissajous",m:"mouse",g:"gamepad",b:"breathe",h:"helical",p:"perlin"}};z.prototype=
{translation:null,orientation:null,drawBasePlate:null,drawPlatformPlate:null,rodLength:0,hornLength:0,hornDirection:0,servoRange:null,servoRangeVisible:!1,sinBeta:[],cosBeta:[],B:[],P:[],q:[],l:[],H:[],T0:[],init:function(a){this.rodLength=a.rodLength;this.hornLength=a.hornLength;this.hornDirection=a.hornDirection;this.drawBasePlate=a.drawBasePlate;this.drawPlatformPlate=a.drawPlatformPlate;this.servoRange=a.servoRange;this.servoRangeVisible=a.servoRangeVisible;this.B=[];this.P=[];this.q=[];this.l=
[];this.H=[];this.sinBeta=[];this.cosBeta=[];const d=a.getLegs.call(this);for(let b=0;b<d.length;b++)this.B.push(d[b].baseJoint),this.P.push(d[b].platformJoint),this.sinBeta.push(Math.sin(d[b].motorRotation)),this.cosBeta.push(Math.cos(d[b].motorRotation)),this.q.push([0,0,0]),this.l.push([0,0,0]),this.H.push([0,0,0]);this.T0=a.absoluteHeight?[0,0,0]:[0,0,Math.sqrt(this.rodLength*this.rodLength+this.hornLength*this.hornLength-Math.pow(this.P[0][0]-this.B[0][0],2)-Math.pow(this.P[0][1]-this.B[0][1],
2))]},initCircular:function(a){a||={};const d=a.baseRadius||80,b=a.platformRadius||50,c=(a.shaftDistance||20)/d,h=(a.anchorDistance||20)/d,f=a.hornDirection||0;this.init({rodLength:a.rodLength||130,hornLength:a.hornLength||50,hornDirection:f,servoRange:a.servoRange||[-Math.PI/2,Math.PI/2],servoRangeVisible:void 0===a.servoRangeVisible?!1:a.servoRangeVisible,getLegs:function(){const g=[];for(let n=0;6>n;n++){var e=n&1?-1:1;const p=(n+n%2)*Math.PI/3+e*c/2;e=(1+n-n%2)*Math.PI/3-e*h/2;g.push({baseJoint:[Math.cos(p)*
d,Math.sin(p)*d,0],platformJoint:[Math.cos(e)*b,Math.sin(e)*b,0],motorRotation:p+(n+f)%2*Math.PI+Math.PI/2})}return g},drawBasePlate:function(g){g.stroke(0);g.fill(254,241,53);g.ellipse(0,0,2*d,2*d)},drawPlatformPlate:function(g){g.stroke(0);g.fill(42,236,253);g.ellipse(0,0,2*b,2*b)}})},initHexagonal:function(a){a||={};const d=a.platformRadius||50,b=a.platformRadiusOuter||80,c=void 0===a.platformTurn?!0:a.platformTurn,h=a.rodLength||130,f=a.hornLength||50,g=a.hornDirection||0,e=a.shaftDistance||20,
n=a.anchorDistance||20,p=G(a.baseRadius||80,a.baseRadiusOuter||110,0),l=G(d,b,c?Math.PI:0);this.init({rodLength:h,hornLength:f,hornDirection:g,servoRange:a.servoRange||[-Math.PI/2,Math.PI/2],servoRangeVisible:void 0===a.servoRangeVisible?!1:a.servoRangeVisible,getLegs:function(){const k=[],m=[],q=[],w=[];for(var r=0;6>r;r++){var u=r|1,x=p[u].x,t=p[u].y;const A=p[(u+1)%6].x;var y=p[(u+1)%6].y,v=A-x;let B=y-t;const H=Math.hypot(v,B),F=r&1?-1:1;x=(x+A)/2;t=(t+y)/2;y=(l[u].x+l[(u+1)%6].x)/2;u=(l[u].y+
l[(u+1)%6].y)/2;v/=H;B/=H;m.push([x+v*e*F,t+B*e*F,0]);q.push([y+v*n*F,u+B*n*F,0]);w.push(Math.atan2(B,v)+(r+g)%2*Math.PI)}r=[0,1,2,3,4,5];c&&(r=[4,3,0,5,2,1]);for(v=0;v<m.length;v++)k.push({baseJoint:m[v],platformJoint:q[r[v]],motorRotation:w[v]});return k},drawBasePlate:function(k){k.stroke(0);k.fill(254,241,53);k.beginShape();for(let m=0;m<p.length;m++)k.vertex(p[m].x,p[m].y);k.endShape(k.CLOSE)},drawPlatformPlate:function(k){k.stroke(0);k.fill(42,236,253);k.beginShape();for(let m=0;m<l.length;m++)k.vertex(l[m].x,
l[m].y);k.endShape(k.CLOSE)}})},draw:function(){function a(b,c,h){let f=0;const g=C/12;b.beginShape(b.TRIANGLE_STRIP);for(var e=0;12>=e;e++)b.vertex(0,0,0),b.vertex(c*Math.cos(f),h,c*Math.sin(f)),f+=g;b.endShape();f=0;b.beginShape(b.TRIANGLE_FAN);b.vertex(0,h,0);for(e=0;13>e;e++)b.vertex(c*Math.cos(f),h,c*Math.sin(f)),f+=g;b.endShape()}function d(b){b.push();b.strokeWeight(2);b.stroke(255,0,0);b.line(0,0,0,40,0,0);b.stroke(0,255,0);b.line(0,0,0,0,40,0);b.stroke(0,0,255);b.line(0,0,0,0,0,40);b.pop();
b.push();b.noStroke();b.fill(255,0,0);b.rotateZ(Math.PI/2);b.translate(0,-50,0);a(b,3,10);b.pop();b.push();b.noStroke();b.fill(0,255,0);b.rotateX(-Math.PI);b.translate(0,-50,0);a(b,3,10);b.pop();b.push();b.noStroke();b.fill(0,0,255);b.rotateX(-Math.PI/2);b.translate(0,-50,0);a(b,3,10);b.pop()}return function(b){d(b);this.drawBasePlate.call(this,b);b.push();b.translate(this.translation[0],this.translation[1],this.translation[2]+this.T0[2]);b.applyMatrix.apply(b,this.orientation.conjugate().toMatrix4());
this.drawPlatformPlate.call(this,b);d(b);b.pop();b.noStroke();b.fill(0);for(var c=0;c<this.B.length;c++)b.push(),b.translate(this.B[c][0],this.B[c][1],this.B[c][2]),b.sphere(3),b.pop();b.noStroke();b.fill(255,0,0);for(c=0;c<this.q.length;c++)b.push(),b.translate(this.q[c][0],this.q[c][1],this.q[c][2]),b.sphere(3),b.pop();b.push();b.stroke(255,0,0);b.strokeWeight(1);for(c=0;c<this.B.length;c++)b.line(this.H[c][0],this.H[c][1],this.H[c][2],this.q[c][0],this.q[c][1],this.q[c][2]);b.pop();b.push();b.stroke(0);
for(c=0;c<this.B.length;c++)b.line(this.B[c][0],this.B[c][1],this.B[c][2],this.H[c][0],this.H[c][1],this.H[c][2]);b.pop();if(this.servoRangeVisible)for(b.fill("rgba(255,0,0,0.1)"),b.noStroke(),c=0;c<this.B.length;c++)b.push(),b.translate(this.B[c][0],this.B[c][1],this.B[c][2]),b.rotateX(Math.PI/2),b.rotateY(Math.atan2(this.H[c][1]-this.B[c][1],this.H[c][0]-this.B[c][0])),b.arc(0,0,2*this.hornLength,2*this.hornLength,this.servoRange[0],this.servoRange[1],b.PIE),b.pop()}}(),update:function(a,d){const b=
this.hornLength,c=this.rodLength,h=this.q,f=this.l,g=this.B,e=this.P,n=this.H,p=this.T0[2];this.translation=a;this.orientation=d;for(let q=0;q<g.length;q++){var l=d.rotateVector(e[q]),k=f[q],m=h[q];const w=n[q],r=g[q];m[0]=a[0]+l[0];m[1]=a[1]+l[1];m[2]=a[2]+l[2]+p;k[0]=m[0]-r[0];k[1]=m[1]-r[1];k[2]=m[2]-r[2];l=k[0]*k[0]+k[1]*k[1]+k[2]*k[2]-c*c+b*b;m=2*b*k[2];const u=2*b*(this.cosBeta[q]*k[0]+this.sinBeta[q]*k[1]),x=m*m+u*u,t=Math.sqrt(Math.max(0,1-l*l/x)),y=Math.sqrt(x);k=l*m/x-u*t/y;l=l*u/x+m*t/
y;w[0]=r[0]+b*l*this.cosBeta[q];w[1]=r[1]+b*l*this.sinBeta[q];w[2]=r[2]+b*k}},getServoAngles:function(){const a=[];for(let d=0;d<this.B.length;d++)a[d]=Math.asin((this.H[d][2]-this.B[d][2])/this.hornLength),isNaN(a[d])?a[d]=null:this.servoRange[0]<=a[d]&&a[d]<=this.servoRange[1]||(a[d]=null);return a}};z.Animation=D;"function"===typeof define&&define.amd?define([],function(){return z}):"object"===typeof exports?(Object.defineProperty(z,"__esModule",{value:!0}),z["default"]=z,z.Stewart=z,module.exports=
z):E.Stewart=z})(this);
